{% extends "analytics/base_analytics.html" %}

{% block analytics_header %}
<div class="d-flex justify-content-between align-items-center">
    <h2>Analytics Dashboard</h2>
    <div class="btn-group">
        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
            Time Range
        </button>
        <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" onclick="updateTimeRange(7)">Last 7 Days</a></li>
            <li><a class="dropdown-item" href="#" onclick="updateTimeRange(30)">Last 30 Days</a></li>
            <li><a class="dropdown-item" href="#" onclick="updateTimeRange(90)">Last 90 Days</a></li>
        </ul>
        <button class="btn btn-success ms-2" onclick="exportData()">
            <i class="fas fa-download"></i> Export Data
        </button>
    </div>
</div>
{% endblock %}

{% block analytics_content %}
<div class="row mb-4">
    <!-- Tickets by Status -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Tickets by Status</h5>
            </div>
            <div class="card-body">
                <canvas id="ticketStatusChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Response Times -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Response Times</h5>
            </div>
            <div class="card-body">
                <canvas id="responseTimeChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <!-- SLA Compliance -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">SLA Compliance</h5>
            </div>
            <div class="card-body">
                <canvas id="slaComplianceChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Agent Performance -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Agent Performance</h5>
            </div>
            <div class="card-body">
                <canvas id="agentPerformanceChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Additional Metrics -->
<div class="row">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <h6 class="card-title">Open Tickets</h6>
                <h2 id="openTicketsCount">-</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <h6 class="card-title">Avg Response Time</h6>
                <h2 id="avgResponseTime">-</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <h6 class="card-title">SLA Compliance</h6>
                <h2 id="slaComplianceRate">-</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <h6 class="card-title">Resolution Rate</h6>
                <h2 id="resolutionRate">-</h2>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
let currentDays = 30;
let charts = {};

async function loadCharts() {
    // Load all charts
    const ticketStatus = await fetchData('tickets_by_status');
    const responseTimes = await fetchData('response_times');
    const slaCompliance = await fetchData('sla_compliance');
    const agentPerformance = await fetchData('agent_performance');
    
    // Tickets by Status (Pie Chart)
    charts.ticketStatus = new Chart(document.getElementById('ticketStatusChart'), {
        type: 'pie',
        data: ticketStatus,
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    
    // Response Times (Line Chart)
    charts.responseTimes = new Chart(document.getElementById('responseTimeChart'), {
        type: 'line',
        data: responseTimes,
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // SLA Compliance (Line Chart)
    charts.slaCompliance = new Chart(document.getElementById('slaComplianceChart'), {
        type: 'line',
        data: slaCompliance,
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
    
    // Agent Performance (Bar Chart)
    charts.agentPerformance = new Chart(document.getElementById('agentPerformanceChart'), {
        type: 'bar',
        data: agentPerformance,
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

async function fetchData(reportType) {
    const response = await fetch(`/analytics/data/${reportType}?days=${currentDays}`);
    return await response.json();
}

async function updateTimeRange(days) {
    currentDays = days;
    Object.values(charts).forEach(chart => chart.destroy());
    await loadCharts();
}

async function exportData() {
    window.location.href = `/analytics/export?days=${currentDays}`;
}

// Initial load
document.addEventListener('DOMContentLoaded', loadCharts);
</script>
{% endblock %} 