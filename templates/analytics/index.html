{% extends "analytics/base_analytics.html" %}

{% block analytics_header %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2>Analytics Dashboard</h2>
        <div class="btn-group">
            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                <i class="fas fa-columns"></i> Dashboard
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" onclick="saveDashboard()">Save Layout</a></li>
                <li><a class="dropdown-item" href="#" onclick="resetLayout()">Reset Layout</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#metricsModal">
                    Customize Metrics
                </a></li>
            </ul>
        </div>
    </div>
    <div class="btn-group">
        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" id="timeRangeBtn">
            Last 30 Days
        </button>
        <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" onclick="updateTimeRange(7)">Last 7 Days</a></li>
            <li><a class="dropdown-item" href="#" onclick="updateTimeRange(30)">Last 30 Days</a></li>
            <li><a class="dropdown-item" href="#" onclick="updateTimeRange(90)">Last 90 Days</a></li>
        </ul>
        <button class="btn btn-primary ms-2" type="button" data-bs-toggle="modal" data-bs-target="#exportModal">
            <i class="fas fa-file-export"></i> Export Raw Data
        </button>
    </div>
</div>

<div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exportModalLabel">Export Filtered Data</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="exportForm">
                    <div class="mb-3">
                        <label class="form-label">Date Range</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="dateRange" name="date_range" placeholder="Select date range">
                            <button class="btn btn-outline-secondary" type="button" id="clearDates">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <small class="form-text text-muted">Required. Please select a date range for export.</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input select-all" id="selectAllStatus">
                            <label class="form-check-label" for="selectAllStatus">Select All</label>
                        </div>
                        <div class="status-options">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input status-option" name="status" value="open" id="statusOpen">
                                <label class="form-check-label" for="statusOpen">Open</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input status-option" name="status" value="in_progress" id="statusInProgress">
                                <label class="form-check-label" for="statusInProgress">In Progress</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input status-option" name="status" value="on_hold" id="statusOnHold">
                                <label class="form-check-label" for="statusOnHold">On Hold</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input status-option" name="status" value="resolved" id="statusResolved">
                                <label class="form-check-label" for="statusResolved">Resolved</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input status-option" name="status" value="closed" id="statusClosed">
                                <label class="form-check-label" for="statusClosed">Closed</label>
                            </div>
                        </div>
                        <small class="form-text text-muted">Select at least one status.</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Priority</label>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input select-all" id="selectAllPriority">
                            <label class="form-check-label" for="selectAllPriority">Select All</label>
                        </div>
                        <div class="priority-options">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input priority-option" name="priority" value="low" id="priorityLow">
                                <label class="form-check-label" for="priorityLow">Low</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input priority-option" name="priority" value="medium" id="priorityMedium">
                                <label class="form-check-label" for="priorityMedium">Medium</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input priority-option" name="priority" value="high" id="priorityHigh">
                                <label class="form-check-label" for="priorityHigh">High</label>
                            </div>
                        </div>
                        <small class="form-text text-muted">Select at least one priority.</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="exportFilteredData()">Export</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Metrics Customization Modal -->
<div class="modal fade" id="metricsModal">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Customize Dashboard</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#metricsTab">Metrics</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#chartsTab">Charts</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#filtersTab">Filters</a>
                    </li>
                </ul>
                
                <div class="tab-content mt-3">
                    <!-- Metrics Tab -->
                    <div class="tab-pane fade show active" id="metricsTab">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Available Metrics</h6>
                                <div class="list-group" id="availableMetrics">
                                    <!-- Populated via JavaScript -->
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Selected Metrics</h6>
                                <div class="list-group" id="selectedMetrics">
                                    <!-- Populated via JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Charts Tab -->
                    <div class="tab-pane fade" id="chartsTab">
                        <div class="row" id="chartCustomizations">
                            <!-- Populated via JavaScript -->
                        </div>
                    </div>
                    
                    <!-- Filters Tab -->
                    <div class="tab-pane fade" id="filtersTab">
                        <div class="mb-3">
                            <label class="form-label">Default Time Range</label>
                            <select class="form-select" id="defaultTimeRange">
                                <option value="7">Last 7 Days</option>
                                <option value="30">Last 30 Days</option>
                                <option value="90">Last 90 Days</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Additional Filters</label>
                            <div id="additionalFilters">
                                <!-- Populated via JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveCustomizations()">Save Changes</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block analytics_content %}
<div class="dashboard-grid" id="dashboardGrid">
    <!-- Metrics Cards -->
    <div class="row mb-4" id="metricsRow">
        <div class="col-md-3">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="card-title text-muted mb-0">Open Tickets</h6>
                    <h2 class="mb-0" id="openTicketsCount">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="card-title text-muted mb-0">Avg Response Time</h6>
                    <h2 class="mb-0" id="avgResponseTime">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="card-title text-muted mb-0">SLA Compliance</h6>
                    <h2 class="mb-0" id="slaComplianceRate">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="card-title text-muted mb-0">Resolution Rate</h6>
                    <h2 class="mb-0" id="resolutionRate">-</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Grid -->
    <div class="row" id="chartsGrid">
        <!-- Tickets by Status -->
        <div class="col-md-6">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-transparent border-0">
                    <h5 class="mb-0">Tickets by Status</h5>
                </div>
                <div class="card-body">
                    <canvas id="ticketStatusChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Response Times -->
        <div class="col-md-6">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-transparent border-0">
                    <h5 class="mb-0">Response Times</h5>
                </div>
                <div class="card-body">
                    <canvas id="responseTimeChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row" id="chartsGrid">
        <!-- SLA Compliance -->
        <div class="col-md-6">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-transparent border-0">
                    <h5 class="mb-0">SLA Compliance</h5>
                </div>
                <div class="card-body">
                    <canvas id="slaComplianceChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Agent Performance -->
        <div class="col-md-6">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-transparent border-0">
                    <h5 class="mb-0">Agent Performance</h5>
                </div>
                <div class="card-body">
                    <canvas id="agentPerformanceChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
let currentDays = 30;
let charts = {};

// Professional color palette
const chartColors = {
    primary: ['#2c7be5', '#1a68d1', '#1657af', '#12478d', '#0d356b'],
    accent: ['#00d97e', '#39f', '#6e84a3', '#fd7e14', '#e63757'],
    background: ['#f9fbfd', '#f6f9fc', '#edf2f9', '#e3ebf6', '#d2ddec']
};

async function loadCharts() {
    try {
        // Load summary metrics first
        const summaryMetrics = await fetchData('summary');
        updateSummaryMetrics(summaryMetrics);
        
        // Then load chart data
        const ticketStatus = await fetchData('tickets_by_status');
        const responseTimes = await fetchData('response_times');
        const slaCompliance = await fetchData('sla_compliance');
        const agentPerformance = await fetchData('agent_performance');
        
        // Initialize charts
        charts.ticketStatus = new Chart(document.getElementById('ticketStatusChart'), {
            type: 'pie',
            data: ticketStatus
        });

        charts.responseTimes = new Chart(document.getElementById('responseTimeChart'), {
            type: 'line',
            data: responseTimes
        });

        charts.slaCompliance = new Chart(document.getElementById('slaComplianceChart'), {
            type: 'line',
            data: slaCompliance
        });

        charts.agentPerformance = new Chart(document.getElementById('agentPerformanceChart'), {
            type: 'bar',
            data: agentPerformance
        });
    } catch (error) {
        console.error('Error loading data:', error);
    }
}

async function fetchData(reportType) {
    const response = await fetch(`/analytics/data/${reportType}?days=${currentDays}`);
    return await response.json();
}

async function updateTimeRange(days) {
    currentDays = days;
    // Update the button text
    const timeRangeBtn = document.getElementById('timeRangeBtn');
    timeRangeBtn.textContent = `Last ${days} Days`;
    
    // Update charts
    Object.values(charts).forEach(chart => chart.destroy());
    await loadCharts();
}

// Initialize Litepicker when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    const picker = new Litepicker({
        element: document.getElementById('dateRange'),
        singleMode: false,
        numberOfMonths: 2,
        numberOfColumns: 2,
        startDate: new Date(),
        endDate: new Date(),
        format: 'YYYY-MM-DD',
        showTooltip: true,
        tooltipText: {
            one: 'day',
            other: 'days'
        },
        plugins: ['ranges'],
        ranges: {
            'Today': [new Date(), new Date()],
            'Yesterday': [new Date(new Date().setDate(new Date().getDate() - 1)), new Date(new Date().setDate(new Date().getDate() - 1))],
            'Last 7 Days': [new Date(new Date().setDate(new Date().getDate() - 6)), new Date()],
            'Last 30 Days': [new Date(new Date().setDate(new Date().getDate() - 29)), new Date()],
            'This Month': [new Date(new Date().setDate(1)), new Date()],
            'Last Month': [
                new Date(new Date().setMonth(new Date().getMonth() - 1, 1)),
                new Date(new Date().setMonth(new Date().getMonth(), 0))
            ]
        },
        setup: (picker) => {
            picker.on('selected', (date1, date2) => {
                document.getElementById('start_date').value = date1.format('YYYY-MM-DD');
                document.getElementById('end_date').value = date2.format('YYYY-MM-DD');
            });
        }
    });

    // Add hidden inputs for form submission
    const form = document.getElementById('exportForm');
    const startDateInput = document.createElement('input');
    startDateInput.type = 'hidden';
    startDateInput.id = 'start_date';
    startDateInput.name = 'start_date';
    const endDateInput = document.createElement('input');
    endDateInput.type = 'hidden';
    endDateInput.id = 'end_date';
    endDateInput.name = 'end_date';
    form.appendChild(startDateInput);
    form.appendChild(endDateInput);

    // Clear dates button handler
    document.getElementById('clearDates').addEventListener('click', () => {
        picker.clearSelection();
        document.getElementById('start_date').value = '';
        document.getElementById('end_date').value = '';
    });

    // Load charts
    loadCharts();

    // Initialize select all checkboxes
    document.querySelectorAll('.select-all').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const container = this.closest('.mb-3');
            const options = container.querySelectorAll(this.id.includes('Status') ? '.status-option' : '.priority-option');
            options.forEach(option => option.checked = this.checked);
        });
    });

    // Initialize option checkboxes
    ['status', 'priority'].forEach(type => {
        const container = document.querySelector(`.${type}-options`);
        const options = container.querySelectorAll(`.${type}-option`);
        const selectAll = document.querySelector(`#selectAll${type.charAt(0).toUpperCase() + type.slice(1)}`);
        
        options.forEach(option => {
            option.addEventListener('change', function() {
                const allChecked = Array.from(options).every(opt => opt.checked);
                const someChecked = Array.from(options).some(opt => opt.checked);
                selectAll.checked = allChecked;
                selectAll.indeterminate = someChecked && !allChecked;
            });
        });
    });

    // Select all by default
    document.querySelectorAll('.select-all').forEach(checkbox => {
        checkbox.click();
    });

    // Set initial text when page loads
    const timeRangeBtn = document.getElementById('timeRangeBtn');
    timeRangeBtn.textContent = `Last ${currentDays} Days`;
});

function exportFilteredData() {
    const form = document.getElementById('exportForm');
    const formData = new FormData(form);
    const dateRange = document.getElementById('dateRange').value;
    
    if (!dateRange) {
        alert('Please select a date range');
        return;
    }

    const status = formData.getAll('status');
    const priority = formData.getAll('priority');

    if (status.length === 0) {
        alert('Please select at least one status');
        return;
    }

    // Build query string
    const params = new URLSearchParams();
    for (let [key, value] of formData.entries()) {
        if (value) params.append(key, value);
    }
    
    // Redirect to export URL with filters
    window.location.href = `/analytics/raw-export?${params.toString()}`;
}

function updateSummaryMetrics(data) {
    if (!data) return;
    
    document.getElementById('openTicketsCount').textContent = data.open_tickets || '0';
    document.getElementById('avgResponseTime').textContent = data.avg_response_time ? `${data.avg_response_time}h` : '0h';
    document.getElementById('slaComplianceRate').textContent = data.sla_compliance_rate ? `${data.sla_compliance_rate}%` : '0%';
    document.getElementById('resolutionRate').textContent = data.resolution_rate ? `${data.resolution_rate}%` : '0%';
}

// Add after the existing script section
const availableMetrics = {
    tickets: {
        open_tickets: { label: 'Open Tickets', type: 'number' },
        avg_response: { label: 'Average Response Time', type: 'duration' },
        sla_compliance: { label: 'SLA Compliance', type: 'percentage' },
        resolution_rate: { label: 'Resolution Rate', type: 'percentage' }
    },
    charts: {
        tickets_by_status: {
            label: 'Tickets by Status',
            types: ['pie', 'doughnut', 'bar'],
            default: 'pie'
        },
        response_times: {
            label: 'Response Times',
            types: ['line', 'bar'],
            default: 'line'
        },
        sla_compliance: {
            label: 'SLA Compliance',
            types: ['line', 'bar'],
            default: 'line'
        },
        agent_performance: {
            label: 'Agent Performance',
            types: ['bar', 'horizontalBar'],
            default: 'bar'
        }
    }
};

// Initialize draggable grid
document.addEventListener('DOMContentLoaded', function() {
    // Initialize grid
    const grid = new Muuri('.dashboard-grid', {
        dragEnabled: true,
        dragHandle: '.card-header',
        dragContainer: document.body,
        dragAutoScroll: {
            targets: [window]
        }
    });

    // Populate available metrics
    const metricsContainer = document.getElementById('availableMetrics');
    Object.entries(availableMetrics.tickets).forEach(([key, metric]) => {
        const item = document.createElement('div');
        item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
        item.setAttribute('data-metric', key);
        item.innerHTML = `
            ${metric.label}
            <button class="btn btn-sm btn-outline-primary add-metric">
                <i class="fas fa-plus"></i>
            </button>
        `;
        metricsContainer.appendChild(item);
    });

    // Populate chart customizations
    const chartsContainer = document.getElementById('chartCustomizations');
    Object.entries(availableMetrics.charts).forEach(([key, chart]) => {
        const col = document.createElement('div');
        col.className = 'col-md-6 mb-3';
        col.innerHTML = `
            <div class="card">
                <div class="card-body">
                    <h6>${chart.label}</h6>
                    <select class="form-select chart-type" data-chart="${key}">
                        ${chart.types.map(type => 
                            `<option value="${type}" ${type === chart.default ? 'selected' : ''}>
                                ${type.charAt(0).toUpperCase() + type.slice(1)}
                            </option>`
                        ).join('')}
                    </select>
                </div>
            </div>
        `;
        chartsContainer.appendChild(col);
    });

    // Save dashboard layout
    window.saveDashboard = async function() {
        const layout = grid.getLayout();
        const chartTypes = {};
        document.querySelectorAll('.chart-type').forEach(select => {
            chartTypes[select.dataset.chart] = select.value;
        });

        const config = {
            layout: layout.map(item => ({
                id: item.getElement().getAttribute('data-id'),
                position: item.getPosition()
            })),
            chartTypes: chartTypes,
            selectedMetrics: Array.from(document.getElementById('selectedMetrics').children)
                .map(item => item.getAttribute('data-metric'))
        };

        try {
            const response = await fetch('/analytics/save-dashboard', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                },
                body: JSON.stringify(config)
            });
            
            if (!response.ok) throw new Error('Failed to save dashboard');
            
            showToast('Dashboard layout saved successfully');
        } catch (error) {
            console.error('Error saving dashboard:', error);
            showToast('Error saving dashboard', 'error');
        }
    };

    // Handle chart type changes
    document.querySelectorAll('.chart-type').forEach(select => {
        select.addEventListener('change', function() {
            const chartId = this.dataset.chart;
            const chartInstance = charts[chartId];
            if (chartInstance) {
                chartInstance.destroy();
                charts[chartId] = new Chart(document.getElementById(`${chartId}Chart`), {
                    type: this.value,
                    data: chartInstance.data
                });
            }
        });
    });
});
</script>
{% endblock %} 