{% extends "analytics/base_analytics.html" %}

{% block analytics_header %}
<div class="d-flex justify-content-between align-items-center">
    <h2>Analytics Dashboard</h2>
    <div class="btn-group">
        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
            Time Range
        </button>
        <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" onclick="updateTimeRange(7)">Last 7 Days</a></li>
            <li><a class="dropdown-item" href="#" onclick="updateTimeRange(30)">Last 30 Days</a></li>
            <li><a class="dropdown-item" href="#" onclick="updateTimeRange(90)">Last 90 Days</a></li>
        </ul>
        <button class="btn btn-primary ms-2" type="button" data-bs-toggle="modal" data-bs-target="#exportModal">
            <i class="fas fa-file-export"></i> Export Raw Data
        </button>
    </div>
</div>

<div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exportModalLabel">Export Filtered Data</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="exportForm">
                    <div class="mb-3">
                        <label class="form-label">Date Range</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="dateRange" name="date_range" placeholder="Select date range">
                            <button class="btn btn-outline-secondary" type="button" id="clearDates">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <select class="form-select" name="status" multiple>
                            <option value="open">Open</option>
                            <option value="in_progress">In Progress</option>
                            <option value="pending">Pending</option>
                            <option value="resolved">Resolved</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Priority</label>
                        <select class="form-select" name="priority" multiple>
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="exportFilteredData()">Export</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block analytics_content %}
<div class="row mb-4">
    <!-- Tickets by Status -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Tickets by Status</h5>
            </div>
            <div class="card-body">
                <canvas id="ticketStatusChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Response Times -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Response Times</h5>
            </div>
            <div class="card-body">
                <canvas id="responseTimeChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <!-- SLA Compliance -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">SLA Compliance</h5>
            </div>
            <div class="card-body">
                <canvas id="slaComplianceChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Agent Performance -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Agent Performance</h5>
            </div>
            <div class="card-body">
                <canvas id="agentPerformanceChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Additional Metrics -->
<div class="row">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <h6 class="card-title">Open Tickets</h6>
                <h2 id="openTicketsCount">-</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <h6 class="card-title">Avg Response Time</h6>
                <h2 id="avgResponseTime">-</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <h6 class="card-title">SLA Compliance</h6>
                <h2 id="slaComplianceRate">-</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <h6 class="card-title">Resolution Rate</h6>
                <h2 id="resolutionRate">-</h2>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
let currentDays = 30;
let charts = {};

async function loadCharts() {
    // Load all charts
    const ticketStatus = await fetchData('tickets_by_status');
    const responseTimes = await fetchData('response_times');
    const slaCompliance = await fetchData('sla_compliance');
    const agentPerformance = await fetchData('agent_performance');
    
    // Tickets by Status (Pie Chart)
    charts.ticketStatus = new Chart(document.getElementById('ticketStatusChart'), {
        type: 'pie',
        data: ticketStatus,
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    
    // Response Times (Line Chart)
    charts.responseTimes = new Chart(document.getElementById('responseTimeChart'), {
        type: 'line',
        data: responseTimes,
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // SLA Compliance (Line Chart)
    charts.slaCompliance = new Chart(document.getElementById('slaComplianceChart'), {
        type: 'line',
        data: slaCompliance,
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
    
    // Agent Performance (Bar Chart)
    charts.agentPerformance = new Chart(document.getElementById('agentPerformanceChart'), {
        type: 'bar',
        data: agentPerformance,
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

async function fetchData(reportType) {
    const response = await fetch(`/analytics/data/${reportType}?days=${currentDays}`);
    return await response.json();
}

async function updateTimeRange(days) {
    currentDays = days;
    Object.values(charts).forEach(chart => chart.destroy());
    await loadCharts();
}

// Initialize Litepicker when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    const picker = new Litepicker({
        element: document.getElementById('dateRange'),
        singleMode: false,
        numberOfMonths: 2,
        numberOfColumns: 2,
        startDate: new Date(),
        endDate: new Date(),
        format: 'YYYY-MM-DD',
        showTooltip: true,
        tooltipText: {
            one: 'day',
            other: 'days'
        },
        plugins: ['ranges'],
        ranges: {
            'Today': [new Date(), new Date()],
            'Yesterday': [new Date(new Date().setDate(new Date().getDate() - 1)), new Date(new Date().setDate(new Date().getDate() - 1))],
            'Last 7 Days': [new Date(new Date().setDate(new Date().getDate() - 6)), new Date()],
            'Last 30 Days': [new Date(new Date().setDate(new Date().getDate() - 29)), new Date()],
            'This Month': [new Date(new Date().setDate(1)), new Date()],
            'Last Month': [
                new Date(new Date().setMonth(new Date().getMonth() - 1, 1)),
                new Date(new Date().setMonth(new Date().getMonth(), 0))
            ]
        },
        setup: (picker) => {
            picker.on('selected', (date1, date2) => {
                document.getElementById('start_date').value = date1.format('YYYY-MM-DD');
                document.getElementById('end_date').value = date2.format('YYYY-MM-DD');
            });
        }
    });

    // Add hidden inputs for form submission
    const form = document.getElementById('exportForm');
    const startDateInput = document.createElement('input');
    startDateInput.type = 'hidden';
    startDateInput.id = 'start_date';
    startDateInput.name = 'start_date';
    const endDateInput = document.createElement('input');
    endDateInput.type = 'hidden';
    endDateInput.id = 'end_date';
    endDateInput.name = 'end_date';
    form.appendChild(startDateInput);
    form.appendChild(endDateInput);

    // Clear dates button handler
    document.getElementById('clearDates').addEventListener('click', () => {
        picker.clearSelection();
        document.getElementById('start_date').value = '';
        document.getElementById('end_date').value = '';
    });

    // Load charts
    loadCharts();
});

function exportFilteredData() {
    const form = document.getElementById('exportForm');
    const formData = new FormData(form);
    
    // Build query string
    const params = new URLSearchParams();
    for (let [key, value] of formData.entries()) {
        if (value) params.append(key, value);
    }
    
    // Redirect to export URL with filters
    window.location.href = `/analytics/raw-export?${params.toString()}`;
}
</script>
{% endblock %} 